<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CodeLens ‚Äî System Status</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/css/app.css" />
</head>
<body>
  <nav class="nav">
    <div class="nav-brand">
      <a href="/" style="display:flex;align-items:center;gap:0.5rem;text-decoration:none;color:inherit">
        <span class="nav-logo">‚ü®/‚ü©</span>
        <span class="nav-name">CodeLens</span>
      </a>
    </div>
    <div class="nav-links">
      <a href="/" class="nav-link">‚Üê Back to App</a>
    </div>
  </nav>

  <main class="status-main">
    <div class="status-header">
      <h1 class="status-title">System Status</h1>
      <p class="status-subtitle">Real-time health of all services</p>
      <div class="status-overall" id="status-overall">
        <span class="status-dot" id="overall-dot"></span>
        <span id="overall-text">Checking‚Ä¶</span>
      </div>
    </div>

    <div class="status-grid">
      <!-- Backend -->
      <div class="status-card" id="card-backend">
        <div class="status-card-icon">üñ•</div>
        <div class="status-card-body">
          <h3 class="status-card-title">Backend</h3>
          <p class="status-card-sub">FastAPI application server</p>
          <div class="status-card-badge" id="badge-backend">‚Äî</div>
          <p class="status-card-msg" id="msg-backend">Checking‚Ä¶</p>
        </div>
      </div>

      <!-- Database -->
      <div class="status-card" id="card-database">
        <div class="status-card-icon">üóÑ</div>
        <div class="status-card-body">
          <h3 class="status-card-title">Database</h3>
          <p class="status-card-sub">SQLite persistence layer</p>
          <div class="status-card-badge" id="badge-database">‚Äî</div>
          <p class="status-card-msg" id="msg-database">Checking‚Ä¶</p>
        </div>
      </div>

      <!-- LLM -->
      <div class="status-card" id="card-llm">
        <div class="status-card-icon">ü§ñ</div>
        <div class="status-card-body">
          <h3 class="status-card-title">LLM Connection</h3>
          <p class="status-card-sub">Google Gemini API</p>
          <div class="status-card-badge" id="badge-llm">‚Äî</div>
          <p class="status-card-msg" id="msg-llm">Checking‚Ä¶</p>
        </div>
      </div>
    </div>

    <div class="status-meta">
      <p>Last checked: <span id="last-checked">‚Äî</span></p>
      <p>Response time: <span id="latency">‚Äî</span></p>
      <button class="btn-ghost btn-sm" onclick="checkHealth()">Refresh ‚Ü∫</button>
    </div>

    <div class="status-info-box">
      <h3>About the Stack</h3>
      <div class="stack-items">
        <div class="stack-item">
          <span class="stack-label">LLM Provider</span>
          <span class="stack-value">Google Gemini 1.5 Flash (free tier)</span>
        </div>
        <div class="stack-item">
          <span class="stack-label">Embeddings</span>
          <span class="stack-value">sentence-transformers / all-MiniLM-L6-v2 (local, free)</span>
        </div>
        <div class="stack-item">
          <span class="stack-label">Vector Store</span>
          <span class="stack-value">FAISS (in-process, no external service)</span>
        </div>
        <div class="stack-item">
          <span class="stack-label">Database</span>
          <span class="stack-value">SQLite (file-based, zero-config)</span>
        </div>
        <div class="stack-item">
          <span class="stack-label">Backend</span>
          <span class="stack-value">Python 3.11 + FastAPI + Uvicorn</span>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <span>CodeLens ‚Äî Built with FastAPI, Gemini, FAISS &amp; ‚ù§</span>
    <a href="/" class="footer-link">Back to App</a>
  </footer>

  <script>
    async function checkHealth() {
      document.getElementById("overall-text").textContent = "Checking‚Ä¶";
      document.getElementById("overall-dot").className = "status-dot dot-checking";

      try {
        const res = await fetch("/api/health");
        const data = await res.json();

        // Overall
        const overall = data.status === "ok";
        document.getElementById("overall-dot").className = `status-dot ${overall ? "dot-ok" : "dot-error"}`;
        document.getElementById("overall-text").textContent = overall ? "All systems operational" : "Some services degraded";
        document.getElementById("last-checked").textContent = new Date(data.timestamp).toLocaleString();
        document.getElementById("latency").textContent = `${data.latency_ms} ms`;

        // Individual services
        const services = {
          backend: data.services.backend,
          database: data.services.database,
          llm: data.services.llm,
        };

        for (const [key, svc] of Object.entries(services)) {
          const badge = document.getElementById(`badge-${key}`);
          const msg = document.getElementById(`msg-${key}`);
          const card = document.getElementById(`card-${key}`);

          const isOk = svc.status === "ok";
          badge.textContent = isOk ? "Operational" : "Error";
          badge.className = `status-card-badge ${isOk ? "badge-ok" : "badge-error"}`;
          msg.textContent = svc.message;
          card.className = `status-card ${isOk ? "" : "card-error"}`;
        }
      } catch (e) {
        document.getElementById("overall-dot").className = "status-dot dot-error";
        document.getElementById("overall-text").textContent = "Unable to reach backend";
      }
    }

    checkHealth();
    setInterval(checkHealth, 30000);
  </script>
</body>
</html>